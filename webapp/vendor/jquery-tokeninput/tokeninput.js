(function(b){var z={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null},A={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",
highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},i={BEFORE:0,AFTER:1,END:2},f={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};b.fn.tokenInput=function(f,i){var a=b.extend({},z,i||{});return this.each(function(){new b.TokenList(this,
f,a)})};b.TokenList=function(p,x,a){function s(c,d){var e=b("<li><p>"+d+"</p></li>").addClass(a.classes.token).insertBefore(n);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){F(b(this).parent());return!1});var j={id:c,name:d};b.data(e.get(0),"tokeninput",j);o=o.slice(0,l).concat([j]).concat(o.slice(l));l++;j=b.map(o,function(a){return a.id});k.val(j.join(a.tokenDelimiter));t+=1;return e}function G(c){var d=b.data(c.get(0),"tokeninput"),c=a.onAdd;if(t>
0&&a.preventDuplicates){var e=null;u.children().each(function(){var a=b(this),c=b.data(a.get(0),"tokeninput");if(c&&c.id===d.id)return e=a,!1});if(e){w(e);n.insertAfter(e);g.focus();return}}s(d.id,d.name);a.tokenLimit!==null&&t>=a.tokenLimit?(g.hide(),q()):(g.focus(),g.val(""),q(),b.isFunction(c)&&c.call(k,d))}function w(c){c.addClass(a.classes.selectedToken);h=c.get(0);g.val("");q()}function v(c,b){c.removeClass(a.classes.selectedToken);h=null;b===i.BEFORE?(n.insertBefore(c),l--):b===i.AFTER?(n.insertAfter(c),
l++):(n.appendTo(u),l=t);g.focus()}function F(c){var d=b.data(c.get(0),"tokeninput"),e=a.onDelete,j=c.prevAll().length;j>l&&j--;c.remove();h=null;g.focus();o=o.slice(0,j).concat(o.slice(j+1));j<l&&l--;c=b.map(o,function(a){return a.id});k.val(c.join(a.tokenDelimiter));t-=1;a.tokenLimit!==null&&g.show().val("").focus();b.isFunction(e)&&e.call(k,d)}function q(){r.hide().empty();m=null}function y(){r.css({position:"absolute",top:b(u).offset().top+b(u).outerHeight(),left:b(u).offset().left,zindex:999}).show()}
function B(c,d){if(d&&d.length){r.empty();var e=b("<ul>").appendTo(r).mouseover(function(a){C(b(a.target).closest("li"))}).mousedown(function(a){G(b(a.target).closest("li"));return!1}).hide();b.each(d,function(d,g){var f=b("<li>"+g.name.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")+"</li>").appendTo(e);d%2?f.addClass(a.classes.dropdownItem):f.addClass(a.classes.dropdownItem2);d===0&&C(f);b.data(f.get(0),"tokeninput",{id:g.id,name:g.name})});y();a.animateDropdown?
e.slideDown("fast"):e.show()}else a.noResultsText&&(r.html("<p>"+a.noResultsText+"</p>"),y())}function C(c){c&&(m&&(b(m).removeClass(a.classes.selectedDropdownItem),m=null),c.addClass(a.classes.selectedDropdownItem),m=c.get(0))}function H(){var c=g.val().toLowerCase();c&&c.length&&(h&&v(b(h),i.AFTER),c.length>=a.minChars?(a.searchingText&&(r.html("<p>"+a.searchingText+"</p>"),y()),clearTimeout(I),I=setTimeout(function(){z(c)},a.searchDelay)):q())}function z(c){var d=D.get(c);if(d)B(c,d);else if(a.url){var e=
{data:{}};a.url.indexOf("?")>-1?(d=a.url.split("?"),e.url=d[0],d=d[1].split("&"),b.each(d,function(a,c){var b=c.split("=");e.data[b[0]]=b[1]})):e.url=a.url;e.data[a.queryParam]=c;e.type=a.method;e.dataType=a.contentType;if(a.crossDomain)e.dataType="jsonp";e.success=function(d){b.isFunction(a.onResult)&&(d=a.onResult.call(k,d));D.add(c,a.jsonContainer?d[a.jsonContainer]:d);g.val().toLowerCase()===c&&B(c,a.jsonContainer?d[a.jsonContainer]:d)};b.ajax(e)}else a.local_data&&(d=b.grep(a.local_data,function(a){return a.name.toLowerCase().indexOf(c.toLowerCase())>
-1}),b.isFunction(a.onResult)&&(d=a.onResult.call(k,d)),D.add(c,d),B(c,d))}if(typeof x==="string"){if(a.url=x,a.crossDomain===void 0)a.crossDomain=a.url.indexOf("://")===-1?!1:location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1]}else if(typeof x==="object")a.local_data=x;a.classes?a.classes=b.extend({},A,a.classes):a.theme?(a.classes={},b.each(A,function(c,b){a.classes[c]=b+"-"+a.theme})):a.classes=A;var o=[],t=0,D=new b.TokenList.Cache,I,E,g=b('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if((a.tokenLimit===
null||a.tokenLimit!==t)&&a.hintText)r.html("<p>"+a.hintText+"</p>"),y()}).blur(function(){q()}).bind("keyup keydown blur update",function(){if(E!==(E=g.val())){var a=E.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");J.html(a);g.width(J.width()+30)}}).keydown(function(a){var d,e;switch(a.keyCode){case f.LEFT:case f.RIGHT:case f.UP:case f.DOWN:if(b(this).val())return d=null,d=a.keyCode===f.DOWN||a.keyCode===f.RIGHT?b(m).next():b(m).prev(),d.length&&C(d),!1;else d=
n.prev(),e=n.next(),d.length&&d.get(0)===h||e.length&&e.get(0)===h?a.keyCode===f.LEFT||a.keyCode===f.UP?v(b(h),i.BEFORE):v(b(h),i.AFTER):(a.keyCode===f.LEFT||a.keyCode===f.UP)&&d.length?w(b(d.get(0))):(a.keyCode===f.RIGHT||a.keyCode===f.DOWN)&&e.length&&w(b(e.get(0)));break;case f.BACKSPACE:d=n.prev();if(b(this).val().length)b(this).val().length===1?q():setTimeout(function(){H()},5);else return h?F(b(h)):d.length&&w(b(d.get(0))),!1;break;case f.TAB:case f.ENTER:case f.NUMPAD_ENTER:case f.COMMA:if(m)return G(b(m)),
!1;break;case f.ESCAPE:return q(),!0;default:String.fromCharCode(a.which)&&setTimeout(function(){H()},5)}}),k=b(p).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),h=null,l=0,m=null,u=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var d=h;h&&v(b(h),i.END);d===a.get(0)?v(a,i.END):w(a)}else h&&v(b(h),i.END),g.focus()}).mouseover(function(c){(c=b(c.target).closest("li"))&&h!==this&&c.addClass(a.classes.highlightedToken)}).mouseout(function(c){(c=
b(c.target).closest("li"))&&h!==this&&c.removeClass(a.classes.highlightedToken)}).insertBefore(k),n=b("<li />").addClass(a.classes.inputToken).appendTo(u).append(g),r=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),J=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});k.val("");p=a.prePopulate||k.data("pre");
a.processPrePopulate&&b.isFunction(a.onResult)&&(p=a.onResult.call(k,p));p&&p.length&&b.each(p,function(a,b){s(b.id,b.name)})};b.TokenList.Cache=function(f){var i=b.extend({max_size:500},f),a={},s=0;this.add=function(b,f){s>i.max_size&&(a={},s=0);a[b]||(s+=1);a[b]=f};this.get=function(b){return a[b]}}})(jQuery);
